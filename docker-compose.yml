
version: '3.8'

services:
  # 1. Frontend Application (O Painel React)
  salesbot-web:
    build:
      context: .
      dockerfile: Dockerfile.txt
    container_name: salesbot-web
    restart: always
    ports:
      - "3005:80"
    environment:
      # Atualizado para porta 8085 (externa)
      - VITE_API_URL=http://localhost:8085/api/v1/query
      - VITE_GATEWAY_URL=http://localhost:8082
      - VITE_USE_MOCK=false
      # API_KEY Removida por segurança (backend que gerencia)
    depends_on:
      - salesbot-api
      - whatsapp-gateway

  # 2. SQL API Connector (Node.js + SQL Server + AI Agent Backend)
  salesbot-api:
    build:
      context: .
      dockerfile: Dockerfile.api.txt
    container_name: salesbot-api
    restart: always
    ports:
      # Porta Externa 8085 mapeada para Interna 8080 para evitar conflito
      - "8085:8080"
    environment:
      - DB_HOST=consulta.flagcloud.com.br
      - DB_USER=SQL10071188
      - DB_PASS=SQL2020/R@1nh@
      - DB_NAME=flexx10071188
      # --- GERE UMA NOVA CHAVE NO GOOGLE AI STUDIO E COLE ABAIXO ---
      - API_KEY=COLE_SUA_NOVA_CHAVE_AQUI
      - SECRET_KEY=minha-senha-secreta-api
    depends_on:
      - sql-server

  # 3. WhatsApp Gateway (Evolution API V2)
  whatsapp-gateway:
    image: atendai/evolution-api:v2.1.1
    container_name: whatsapp-gateway
    restart: always
    ports:
      - "8082:8080"
    environment:
      - AUTHENTICATION_API_KEY=minha-senha-secreta-api
      - SERVER_PORT=8080
      - SERVER_TYPE=http
      
      # Configurações de Navegador para evitar bloqueio e erro de conexão
      - CONFIG_SESSION_PHONE_CLIENT=SalesBot
      - CONFIG_SESSION_PHONE_NAME=Chrome
      - BROWSER_ARGS=--no-sandbox --disable-setuid-sandbox --disable-dev-shm-usage --disable-accelerated-2d-canvas --no-first-run --no-zygote --single-process --disable-gpu
      
      # Banco de Dados (Usando Local Store para simplicidade)
      - DATABASE_ENABLED=false
      
      # Logs e Performance
      - LOG_LEVEL=ERROR
      - DEL_INSTANCE=false
      
      # Webhooks
      - WEBHOOK_GLOBAL_URL=http://salesbot-api:8080/api/v1/whatsapp/webhook
      - WEBHOOK_GLOBAL_ENABLED=true
      - WEBHOOK_EVENTS_APPLICATION_STARTUP=false
      - WEBHOOK_EVENTS_QRCODE_UPDATED=true
      - WEBHOOK_EVENTS_MESSAGES_SET=false # Desativado para performance
      - WEBHOOK_EVENTS_MESSAGES_UPSERT=true
    volumes:
      - evolution_instances:/evolution/instances
      - evolution_store:/evolution/store

  # 4. SQL Server (Banco de Dados Local)
  sql-server:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: salesbot-db
    restart: always
    environment:
      - ACCEPT_EULA=Y
      - SA_PASSWORD=YourStrongPass123!
    ports:
      - "1433:1433"
    volumes:
      - sql_data:/var/opt/mssql

volumes:
  sql_data:
  evolution_instances:
  evolution_store:
